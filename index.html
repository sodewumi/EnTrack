<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js"> <!--<![endif]-->
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    
   
    <!-- WhereBus script files -->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6U2ExB8yLDc7RiGPYK3C3yIzDPpyFJE0&sensor=false"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.7/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.9.3/lodash.js"></script>
   

    <!-- Custom CSS and JV -->
    <script src="maps.js"></script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Firebase Open Data Sets examples - Transit">
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all">



<!-- realtime data JS -->
    <script>
      /**
       * transit.js
       *
       * powering the transit open data example
       */
      /* global Firebase, google, $, _ */
      var transit = {
        people: {},
        map: undefined,
        ref: undefined,
        $container: undefined,
        $system: undefined,
        /**
         * init
         *
         * initialize the module
         */
        init: function () {
          this.$container = $(".transit-opendata-example");
          if (this.$container.length) {
            this.$system = $("#system-selector");
            this.ref = new Firebase("https://publicdata-transit.firebaseio.com/");
            this.animateBuses();
            this.populateMap();
          }
        },
        /**
         * animateBuses
         *
         * attach method to Google Maps Marker prototype to animate movement on data change
         */
        animateBuses: function () {
          var self = this;
          google.maps.Marker.prototype.animatedMoveTo = function (toLat, toLng) {
            var fromLat = this.getPosition().lat();
            var fromLng = this.getPosition().lng();
            var frames = [];
            var isLocationSame = (self._areFloatsAlmostEqual(fromLat, toLat) && self._areFloatsAlmostEqual(fromLng, toLng));
            var currentLat = 0.0;
            var currentLng = 0.0;
            if (isLocationSame) {
              return;
            }
            // CREATE 200 ANIMATION FRAMES FOR BUS
            for (var percent = 0; percent < 1; percent += 0.005) {
              currentLat = fromLat + percent * (toLat - fromLat);
              currentLng = fromLng + percent * (toLng - fromLng);
              frames.push(new google.maps.LatLng(currentLat, currentLng));
            }
            self.moveBus(this, frames, 0, 25);
          };
        },
        /**
         * moveBus
         *
         * display frame by frame the bus's movement on the map
         */
        moveBus: function (marker, latLngs, index, wait) {
          marker.setPosition(latLngs[index]);
          if (index !== latLngs.length - 1) {
            setTimeout(function () {
              this.moveBus(marker, latLngs, index + 1, wait);
            }.bind(this), wait);
          }
        },
        /**
         * populateMap
         *
         * listen for changes in UI and listen to transit firebase
         */
        populateMap: function () {
          var self = this;
          var systemRef;
          var systemData;
          _.forEach(this.transitSystems, function (systemData, sysId) {
            this.$system.append($("<option value='" + sysId + "'>" + systemData.name + "</option>"));
          }, this);
          this.$system.change(function () {
            var mapOptions;
            var system = Number(self.$system.val());
            var name = self.transitSystems[system].tag;
            if (systemRef) {
              systemRef.off();
            }
            mapOptions = {
              center: new google.maps.LatLng(
                  self.transitSystems[system].lat,
                  self.transitSystems[system].lon
              ),
              zoom: self.transitSystems[system].zoom || 8,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            self.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
            systemRef = self.ref.child(name + "/vehicles").limitToLast(200);
            self.createBusListeners(systemRef);
          });
          this.$system.change();
        },
        /**
         * newBus
         *
         * create a new bus marker on Google Maps element
         * @param {Object} bus - contains information about a transit system bus
         * @param {String} busId - the bus's ID in Firebase
         */
        newBus: function (bus, busId) {
          var busLatLng = new google.maps.LatLng(bus.lat, bus.lon);
          // CAPITALIZE THE FIRST LETTER OF BUS ROUTE STRING (if applicable, e.g., for the Brooklyn "B61" bus)
          var busRouteHead = bus.routeTag.toString()[0].toUpperCase();
          var busRouteTail = bus.routeTag.toString().slice(1);
          var tag = busRouteHead + busRouteTail;
          var marker = new google.maps.Marker({
            icon: "https://chart.googleapis.com/chart?chst=d_bubble_icon_text_small&chld=bus|bbT|" + tag + "|7094FF|eee",
            position: busLatLng,
            map: this.map
          });
          this.people[busId] = marker;
        },
        /**
         * createBusListeners
         *
         * update the map when bus data changes
         * @param {Firebase Ref} systemRef - reference to the vehicles node under a transit system Firebase
         */
        createBusListeners: function (systemRef) {
          var self = this;
          systemRef.once("value", function (snapshot) {
            snapshot.forEach(function (bus) {
              self.newBus(bus.val(), bus.key());
            });
          });
          systemRef.on("child_changed", function (snapshot) {
            var busMarker = self.people[snapshot.key()];
            if (busMarker) {
              busMarker.animatedMoveTo(snapshot.val().lat, snapshot.val().lon);
            } else {
              self.newBus(snapshot.val(), snapshot.key());
            }
          });
          systemRef.on("child_removed", function (snapshot) {
            var busMarker = self.people[snapshot.key()];
            if (busMarker) {
              busMarker.setMap(null);
              delete self.people[snapshot.key()];
            }
          });
        },
        /**
         * _areFloatsAlmostEqual
         *
         * test to see if two floats in JS are functionally equal
         * @param {Number} f1 - a number to compare
         * @param {Number} f2 - a number to compare
         * @param {Boolean} - whether the two floats are basically equal
         */
        _areFloatsAlmostEqual: function (f1, f2) {
          return (Math.abs(f1 - f2) < 0.000001);
        },
        /**
         * transitSystem -  listing of all transit systems in example
         * TODO: Need to add in user's geolocation!
         */
        transitSystems: [
          {
            lat: 37.7789,
            lon: -122.3917,
            tag: 'sf-muni',
            city: 'San Francisco',
            state: 'CA',
            name: 'SF MUNI',
            zoom: 15
          }]
      };
      $(document).ready(function () {
        transit.init();
      });

    </script>

    <script>
      $(document).ready(function () {
      var ref = new Firebase("https://dinosaurs.firebaseio.com/");
      $("#submit").click(function () {
        var username = $("#username").val();
        var message = $("#message").val();
        ref.child("messages").push({
          username: username,
          message: message
        });
      });
      ref.child("messages").on("child_added", function (snapshot) {
        var value = snapshot.val();
        var html = $("<li/>").text(value.username + " said " + value.message);
        $("#chat-buffer").append(html);
      });
    });
    </script>



  </head>
  <body>

   <!--  <div id="map-canvas"></div> -->

    <div class="transit-opendata-example">
      <div class="transit-map-canvas" data-example="transit" id="map-canvas"></div>
      <select id="system-selector"></select>
    </div>

    

    <p><button onclick="geoFindMe()">Show my location</button></p>
    <div id="out"></div>

    <!-- chat-buffer = geodata-store -->
    <div id="geodate-store">
    </div>


  </body>
</html>